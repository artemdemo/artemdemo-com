<!DOCTYPE html><html lang="en"><head><title>How to test code that uses moment.js | Artem Demo</title><link rel="icon" type="image/x-icon" href="/./assets/favicon-dec32dcbac.ico"><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="Blog about web development, indie GameDev"><meta property="og:title" content="How to test code that uses moment.js"><meta property="og:description" content="Blog about web development, indie GameDev"><link rel="stylesheet" href="/./assets/code-theme-b13f04ca24.css"><link rel="stylesheet" href="/./assets/site.render-0af6967fec.css"><script async src="https://www.googletagmanager.com/gtag/js?id=G-3BCNZ31TWL"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3BCNZ31TWL');</script></head><body><div><div class="header-wrapper"><div class="container"><div class="header-container"><div class="header-item header-item__logo"><a class="header-logo-link" href="/">Artem Demo &lt;/&gt;</a></div><div class="header-item header-item__menu"><div class="header-item-menu"><div class="top-menu"><div class="top-menu_item top-menu_item__active"><a class="top-menu_link" href="/">Blog</a></div><div class="top-menu_item"><a class="top-menu_link" href="/about/">About</a></div><div class="top-menu_item"><a class="top-menu_link" href="/contact/">Contact me</a></div></div></div></div></div><div class="header-separator"></div></div></div><div class="container"><div class="ContentWrapper"><h1>How to test code that uses moment.js</h1><div class="secondary-text">05 November, 2018</div><div class="post-tags"><div class="secondary-text">Tags: <a class="post-tags-item" href="/blog/tag/moment.js/">moment.js</a><a class="post-tags-item" href="/blog/tag/test/">test</a><a class="post-tags-item" href="/blog/tag/mocks/">mocks</a></div></div><p>I&#x27;m going to talk about unit tests here, not any other kind of tests. And unit tests have, in my opinion, the following list of criteria that they have to meet. This list makes it hard to write tests for code that use external libraries, especially ones that manipulate time:</p><ul><li>Unit tests should be able to run on the developer’s machine as well as on the remote server</li><li>Unit tests shouldn&#x27;t relate to timezone</li><li>Each tested class (or component) should be tested independently from external libraries</li><li>Clarification: All external dependencies should be mocked-up</li></ul><p>With this in mind, let&#x27;s see what we can do.</p><p>First of all, regardless of what your code is - you don&#x27;t want to test 3rd party libraries as well as other components outside of the current unit. This means that we don&#x27;t want to test, for example, how <code class="inline-code">format()</code> or <code class="inline-code">duration()</code> methods work. We should assume that moment is a well tested library and go with it. (In case we aren’t sure, we can create separate test files, that will check moment.js only)</p><p>What does it tell us? Well first of all it defines our approach - we need to mock-up the 3rd party library, instead of using original code.</p><p>Should our code reproduce exact functionality? Absolutely not, we only need to be sure that the methods receive properties that it should receive and that&#x27;s all. But in the case of moment we&#x27;ll need to create some wrapper, that will act like an authentic library. Let&#x27;s see an example of how we use the <code class="inline-code">format()</code> method:</p><pre><code class="language-javascript hljs"><span class="hljs"><span class="hljs-keyword">import</span> moment <span class="hljs-keyword">from</span> &#x27;moment&#x27;;
<span class="hljs-keyword">const</span> timeMoment = <span class="hljs-title function_">moment</span>(<span class="hljs-number">1540500979000</span>);
timeMoment.<span class="hljs-title function_">format</span>(&#x27;<span class="hljs-attr">HH</span>:<span class="hljs-attr">mm</span>:ss, <span class="hljs-variable constant_">YYYY</span>-<span class="hljs-variable constant_">MM</span>-<span class="hljs-variable constant_">DD</span>&#x27;);
</span></code></pre><p>Another example will be usage of the <code class="inline-code">duration()</code> method:</p><pre><code class="language-javascript hljs"><span class="hljs"><span class="hljs-keyword">import</span> moment <span class="hljs-keyword">from</span> &#x27;moment&#x27;;
moment.<span class="hljs-title function_">duration</span>(diffTimestamp).<span class="hljs-title function_">asDays</span>();
</span></code></pre><p>So now we need a file that will reproduce this API, but return only parameters. The solution could be the following code:</p><pre><code class="language-javascript hljs"><span class="hljs"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MomentMock</span>(<span class="hljs-params">time</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MomentMock</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_time</span> = time;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MomentMock</span>(time);
  }
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">_time</span> = time;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">format</span> = (format) =&gt; <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>._time}</span> [<span class="hljs-subst">${format}</span>]`</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">utc</span> = <span class="hljs-title class_">MomentMock</span>;
}

<span class="hljs-title class_">MomentMock</span>.<span class="hljs-property">duration</span> = (time) =&gt; ({
  <span class="hljs-attr">asDays</span>: () =&gt; <span class="hljs-string">`<span class="hljs-subst">${time}</span> asDays`</span>,
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">MomentMock</span>;
</span></code></pre><p>It&#x27;s especially helpful if the time parameter is primitive that represents time, like a timestamp. This way we&#x27;re testing only that we used the right timestamp and format string. Also, we don&#x27;t need to care about the timezone of the machine where we run tests, since we&#x27;re not dealing with <code class="inline-code">Date()</code> objects.</p></div></div></div></body></html>