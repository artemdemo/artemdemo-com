<!DOCTYPE html><html lang="en"><head><title>Renew auth0 token for SPA using js SDK | Artem Demo</title><link rel="icon" type="image/x-icon" href="/./assets/favicon-dec32dcbac.ico"><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="Blog about web development, indie GameDev"><meta property="og:title" content="Renew auth0 token for SPA using js SDK"><meta property="og:description" content="Blog about web development, indie GameDev"><link rel="stylesheet" href="/./assets/code-theme-b13f04ca24.css"><link rel="stylesheet" href="/./assets/site.render-0af6967fec.css"><script async src="https://www.googletagmanager.com/gtag/js?id=G-3BCNZ31TWL"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3BCNZ31TWL');</script></head><body><link rel="preload" as="image" href="chrome-cookies.png"><link rel="preload" as="image" href="chrome-console-warning.png"><div><div class="header-wrapper"><div class="container"><div class="header-container"><div class="header-item header-item__logo"><a class="header-logo-link" href="/">Artem Demo &lt;/&gt;</a></div><div class="header-item header-item__menu"><div class="header-item-menu"><div class="top-menu"><div class="top-menu_item top-menu_item__active"><a class="top-menu_link" href="/">Blog</a></div><div class="top-menu_item"><a class="top-menu_link" href="/about/">About</a></div><div class="top-menu_item"><a class="top-menu_link" href="/contact/">Contact me</a></div></div></div></div></div><div class="header-separator"></div></div></div><div class="container"><div class="ContentWrapper"><h1>Renew auth0 token for SPA using js SDK</h1><div class="secondary-text">11 November, 2019</div><div class="post-tags"><div class="secondary-text">Tags:Â <a class="post-tags-item" href="/blog/tag/auth0/">auth0</a><a class="post-tags-item" href="/blog/tag/token/">token</a><a class="post-tags-item" href="/blog/tag/spa/">spa</a></div></div><p>Sorry, but documentation of auth0 is not the best source of knowledge on how to use auth0. Not something that you expect to happen, right? Official documentation is okay if you need to understand only a basic usage, but if you need more than that, you pretty much on your own. At least it&#x27;s my experience with this service. Especially for not so popular topic of &quot;renewing auth0 token for SPA (Single Page Application)&quot;. So let&#x27;s talk about exactly that.</p><p>First, let&#x27;s understand why we need to renew. It&#x27;s related to, whether you&#x27;re using relatively short expiration time for your token. If you are, which, by the way, will make your app more secure, then you will want to renew token if your app is in active usage. This will make the user experience much more pleasant, so he wouldn&#x27;t need to re-login each time. So the idea is legit, now the question is how to implement it.</p><p>I will start with a description of the expected flow for silent token renewal. By the way auth0 could&#x27;ve done a better job of explaining it. Now I found these steps only in one of their community forums. Here there are:</p><ol><li>User login to the application for the first time.</li><li>When the initial tokens expire the client makes another request to auth0 in order to obtain a new token.</li></ol><p>Ok, that&#x27;s great and the first step is even easy to implement, there is clear document for it. But what about the second one? How it should work and how to implement it? Let&#x27;s talk about exactly that.</p><h2>Auth0 silent token renewal</h2><p>Before we&#x27;ll dive into code example, I want to establish some vocabulary. Auth0 uses different tokens in its lifecycle: access token, refresh token, ID token and some others. It looks like the most relevant are access token and refresh token - the first one we use in order to get access to the API and the second just has the right name. Let&#x27;s look at the definition, provided by auth0 itself:</p><ul><li>access token - a credential that can be used by an application to access an API.</li><li>refresh token - contains the information required to obtain a new Access Token or ID Token.</li></ul><p>So which one we need in the renew flow? Looks like the second one is the obvious choice. But it&#x27;s wrong. The funny thing is that we need neither of them in order to renew existing token for our SPA %) Crazy world.</p><p>I want to emphasize once more - I&#x27;m talking about the SPA lifecycle. My app will interact with auth0 API directly. If you have a different situation, then probably your solution will be different. Are we good? Now we can continue.</p><p>The first step will be to login. We need to start from this basic step in order to initialize the main SDK object with all credentials in place. Without it, we can&#x27;t proceed to renewal.</p><pre><code class="language-js hljs"><span class="hljs"><span class="hljs-comment">// Initialize auth0 instance.</span>
<span class="hljs-comment">// http://auth0.github.io/auth0.js/WebAuth.html</span>
webAuth = <span class="hljs-keyword">new</span> auth0js.<span class="hljs-title class_">WebAuth</span>({
  domain,
  clientID,
  redirectUri,
  audience,
  responseType,
  scope,
});

<span class="hljs-comment">// Kick in authorization with auth0.</span>
<span class="hljs-comment">// https://auth0.com/docs/libraries/auth0js/v9#webauth-authorize-</span>
webAuth.<span class="hljs-title function_">authorize</span>();
</span></code></pre><p>Starting token renew:</p><pre><code class="language-js hljs"><span class="hljs"><span class="hljs-comment">/**
 * Token constructor class
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationToken</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id, access, expiresAt</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">access</span> = access;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">expiresAt</span> = expiresAt;
  }
}

<span class="hljs-keyword">const</span> getTokenFromResult = (result) =&gt; {
  <span class="hljs-keyword">const</span> expiresAt = result.<span class="hljs-property">expiresIn</span> * <span class="hljs-number">1000</span> + <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationToken</span>(result.<span class="hljs-property">idToken</span>, result.<span class="hljs-property">accessToken</span>, expiresAt);
};

<span class="hljs-comment">/**
 * Renew authorization token
 * <span class="hljs-doctag">@param</span> options {object}
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;any&gt;</span>}
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> renewAuth = (options = {}) =&gt;
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>((resolve, reject) =&gt; {
    <span class="hljs-keyword">const</span> _options = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(
      {
        <span class="hljs-attr">audience</span>: authProps.<span class="hljs-property">audience</span>,
        <span class="hljs-attr">redirectUri</span>: <span class="hljs-string">`<span class="hljs-subst">${appUrl}</span>/silent.html`</span>,
        <span class="hljs-attr">usePostMessage</span>: <span class="hljs-literal">true</span>,
      },
      options,
    );
    <span class="hljs-comment">// Executes a silent authentication transaction under the hood</span>
    <span class="hljs-comment">// in order to fetch a new tokens for the current session.</span>
    <span class="hljs-comment">// @link http://auth0.github.io/auth0.js/global.html#renewAuth</span>
    webAuth.<span class="hljs-title function_">renewAuth</span>(_options, (err, result) =&gt; {
      <span class="hljs-keyword">if</span> (err || <span class="hljs-title function_">_get</span>(result, &#x27;error&#x27;)) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(err || result);
      }
      <span class="hljs-keyword">if</span> (result &amp;&amp; result.<span class="hljs-property">accessToken</span> &amp;&amp; result.<span class="hljs-property">idToken</span>) {
        <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">getTokenFromResult</span>(result);
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>(token);
      }
      <span class="hljs-keyword">const</span> errorText = &#x27;<span class="hljs-title class_">Ambiguous</span> response <span class="hljs-keyword">from</span> auth0&#x27;;
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(errorText));
    });
  });
</span></code></pre><p>And here is <code class="inline-code">silent.html</code> file:</p><pre><code class="hljs"><span class="hljs">&lt;!doctype html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-<span class="hljs-number">8</span>&quot; /&gt;
    &lt;script src=&quot;<span class="hljs-attr">https</span>:<span class="hljs-comment">//cdn.auth0.com/js/auth0/9.11/auth0.min.js&quot;&gt;&lt;/script&gt;</span>
    &lt;script&gt;
      <span class="hljs-keyword">var</span> appUrlFromConfig = &#x27;&lt;%= htmlWebpackPlugin.<span class="hljs-property">options</span>.<span class="hljs-property">appUrl</span> %&gt;&#x27;;
      <span class="hljs-keyword">var</span> appUrl = appUrlFromConfig ? appUrlFromConfig : <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>;

      <span class="hljs-keyword">var</span> webAuth = <span class="hljs-keyword">new</span> auth0.<span class="hljs-title class_">WebAuth</span>({
        <span class="hljs-attr">domain</span>: &#x27;&lt;%= htmlWebpackPlugin.<span class="hljs-property">options</span>.<span class="hljs-property">auth0Domain</span> %&gt;&#x27;,
        <span class="hljs-attr">clientID</span>: &#x27;&lt;%= htmlWebpackPlugin.<span class="hljs-property">options</span>.<span class="hljs-property">auth0ClientID</span> %&gt;&#x27;,
        <span class="hljs-attr">redirectUri</span>: appUrl,
        <span class="hljs-attr">audience</span>: &#x27;&lt;%= htmlWebpackPlugin.<span class="hljs-property">options</span>.<span class="hljs-property">auth0Audience</span> %&gt;&#x27;,
        <span class="hljs-attr">responseType</span>: &#x27;&lt;%= htmlWebpackPlugin.<span class="hljs-property">options</span>.<span class="hljs-property">auth0ResponseType</span> %&gt;&#x27;,
        <span class="hljs-attr">scope</span>: &#x27;&lt;%= htmlWebpackPlugin.<span class="hljs-property">options</span>.<span class="hljs-property">auth0PartitionScope</span> %&gt;&#x27;,
      });

      webAuth.<span class="hljs-title function_">parseHash</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">err, response</span>) {
        <span class="hljs-comment">// This message will be handled by auth0 in the main app</span>
        <span class="hljs-comment">// You can find related callback in `webAuth.renewAuth`</span>
        parent.<span class="hljs-title function_">postMessage</span>(err || response, appUrl);
      });
    &lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;&lt;/body&gt;
&lt;/html&gt;
</span></code></pre><p>This is all you need for token renewal. But there are some hidden problems with it. So let&#x27;s see what are they.</p><h2>3rd party cookies for auth0 silent token renewal</h2><p>Another thing that isn&#x27;t mentioned in the official documentation (or at least I don&#x27;t know where it is, and I searched a lot) is the usage of the 3rd party cookies in the process of silent token renewal. In one sentence - they are required. Your browser should allow usage of such cookies. The good thing is that they are generally available in every modern browser, but there is a catch.</p><p>First, let&#x27;s check what is the status of Chrome on your machine. Why Chrome? It&#x27;s just the most popular browser on the planet and if you want to check it for any other browser, you&#x27;ll find a way :)</p><p>You can check your setting by going to this URL chrome://settings/content/cookies - you should see something like that:</p><p><img src="chrome-cookies.png" alt="Chrome cookies"></p><p>Property &quot;Block third-party cookies&quot; (third from the top in my case) should be disabled. For the users, that have it enabled silent token renewal will not work.</p><p>Ok, but our problems are not ending there. In the next year, Chrome will introduce a new policy for the cookies and will require to use property SameSite. In case this property is not set, again cookies will not work. Already today you can see the following warning in the browser console:</p><blockquote><p><em>A cookie associated with a cross-site resource at &quot;URL&quot; was set without the <code class="inline-code">SameSite</code> attribute. A future release of Chrome will only deliver cookies with cross-site requests if they are set with <code class="inline-code">SameSite=None</code> and <code class="inline-code">Secure</code>. You can review cookies in developer tools under Application&gt;Storage&gt;Cookies and see more details at &quot;URL&quot; and &quot;URL&quot;.</em></p></blockquote><p>In Chrome console it will look like this:</p><p><img src="chrome-console-warning.png" alt="Chrome console warning"></p><p>Auth0 support guys are saying that they are aware of the problem and will change their code accordingly. They will need to be ready before Chrome 80, which will be rolled out in Feb 2020. In Chrome 80 all cookies, that don&#x27;t have SameSite, will be ignored by the browser.</p><h2>Conclusion</h2><p>It&#x27;s not an easy task to create a secured authorization system. And I believe that auth0 are trying to do their best in order to provide the best user experience they can. But I still feel that there is room for improvement. I&#x27;m talking first of all about transparency for the developers - better documentation and a better understanding of different environments.</p></div></div></div></body></html>