<!DOCTYPE html><html lang="en"><head><title>Google Drive API - Script initialization | Artem Demo</title><link rel="icon" type="image/x-icon" href="/./assets/favicon-dec32dcbac.ico"><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="Blog about web development, indie GameDev"><meta property="og:title" content="Google Drive API - Script initialization"><meta property="og:description" content="Blog about web development, indie GameDev"><link rel="stylesheet" href="/./assets/code-theme-36bdf5f7fe.css"><link rel="stylesheet" href="/./assets/site.render-5d1535d9c3.css"><script async src="https://www.googletagmanager.com/gtag/js?id=G-3BCNZ31TWL"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3BCNZ31TWL');</script></head><body><div><div class="header-wrapper"><div class="container"><div class="header-container"><div class="header-item header-item__logo"><a class="header-logo-link" href="/">Artem Demo &lt;/&gt;</a></div><div class="header-item header-item__menu"><div class="header-item-menu"><div class="top-menu"><div class="top-menu_item top-menu_item__active"><a class="top-menu_link" href="/">Blog</a></div><div class="top-menu_item"><a class="top-menu_link" href="/about/">About</a></div><div class="top-menu_item"><a class="top-menu_link" href="/contact/">Contact me</a></div></div></div></div></div><div class="header-separator"></div></div></div><div class="container"><div class="ContentWrapper"><h1>Google Drive API - Script initialization</h1><div class="secondary-text">06 July, 2020</div><div class="secondary-text">Tags:Â <a class="post-tags-item" href="/blog/tag/gapi/">gapi</a></div><p>The <a href="https://developers.google.com/drive/api/v3/quickstart/js">basic example</a> from the official documentation is very informative (this is not a sarcasm). I just want to add my 2 cents in order to make it more es6 like, then it is now. Plus I want one function of initialization that will take care of everything. I want to be able to run it from anywhere in the code and be sure that app will be authorized.</p><p>First I need to load the script. I want to do it dynamically from the code and not to attach it to the index.html Also this method could be called multiple times and obviously I don&#x27;t want to attach google script more than once.</p><pre><code class="language-js hljs"><span class="hljs"><span class="hljs-keyword">import</span> { createNanoEvents } <span class="hljs-keyword">from</span> &quot;nanoevents&quot;;
<span class="hljs-keyword">const</span> emitter = <span class="hljs-title function_">createNanoEvents</span>();

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GOOGLE_SCRIPT_ID</span> = <span class="hljs-string">`apis-google-client-<span class="hljs-subst">${getRandom(<span class="hljs-number">5</span>)}</span>`</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DATA_LOADED_ATTR_NAME</span> = &#x27;data-gapi-loaded&#x27;;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SCRIPT_GAPI_LOADED</span> = &#x27;<span class="hljs-variable constant_">SCRIPT_GAPI_LOADED</span>&#x27;;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> _load = () =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>((resolve) =&gt; {
    <span class="hljs-keyword">let</span> scriptEl = &lt;<span class="hljs-title class_">HTMLScriptElement</span>&gt; <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-variable constant_">GOOGLE_SCRIPT_ID</span>);
    <span class="hljs-keyword">if</span> (scriptEl) {
        <span class="hljs-keyword">if</span> (scriptEl.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-variable constant_">DATA_LOADED_ATTR_NAME</span>) !== &#x27;<span class="hljs-literal">true</span>&#x27;) {
            <span class="hljs-keyword">const</span> unbind = emitter.<span class="hljs-title function_">on</span>(<span class="hljs-variable constant_">SCRIPT_GAPI_LOADED</span>, () =&gt; {
                <span class="hljs-title function_">resolve</span>();
                <span class="hljs-comment">// This event should be called only once.</span>
                <span class="hljs-comment">// Since the script is loaded only at the start of the app.</span>
                <span class="hljs-comment">// Therefore I&#x27;m unbounding here</span>
                <span class="hljs-title function_">unbind</span>();
            })
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">resolve</span>();
        }
    } <span class="hljs-keyword">else</span> {
        scriptEl = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(&#x27;script&#x27;);
        scriptEl.<span class="hljs-title function_">setAttribute</span>(&#x27;id&#x27;, <span class="hljs-variable constant_">GOOGLE_SCRIPT_ID</span>);
        scriptEl.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-variable constant_">DATA_LOADED_ATTR_NAME</span>, &#x27;<span class="hljs-literal">false</span>&#x27;);
        scriptEl.<span class="hljs-property">src</span> = &#x27;<span class="hljs-attr">https</span>:<span class="hljs-comment">//apis.google.com/js/client.js&#x27;;</span>

        scriptEl.<span class="hljs-property">onload</span> = () =&gt; {
            gapi.<span class="hljs-title function_">load</span>(&#x27;<span class="hljs-attr">client</span>:auth2&#x27;, () =&gt; {
                scriptEl.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-variable constant_">DATA_LOADED_ATTR_NAME</span>, &#x27;<span class="hljs-literal">true</span>&#x27;);
                emitter.<span class="hljs-title function_">emit</span>(<span class="hljs-variable constant_">SCRIPT_GAPI_LOADED</span>);
                <span class="hljs-title function_">resolve</span>();
            });
        };

        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(scriptEl);
    }
});
</span></code></pre><p>Next step will be gapi client initialization. The same criteria here as well - this method could be called more than once, but initialised only once:</p><pre><code class="language-js hljs"><span class="hljs"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> _init = () =&gt;
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>((resolve, reject) =&gt; {
    <span class="hljs-keyword">if</span> (!gapi.<span class="hljs-property">client</span>.<span class="hljs-title function_">getToken</span>()) {
      gapi.<span class="hljs-property">client</span>
        .<span class="hljs-title function_">init</span>({
          <span class="hljs-attr">apiKey</span>: <span class="hljs-title function_">getApiKey</span>(),
          <span class="hljs-attr">clientId</span>: <span class="hljs-title function_">getClientId</span>(),
          <span class="hljs-attr">discoveryDocs</span>: <span class="hljs-variable constant_">DISCOVERY_DOCS</span>,
          <span class="hljs-attr">scope</span>: <span class="hljs-variable constant_">SCOPES</span>,
        })
        .<span class="hljs-title function_">then</span>(resolve, reject);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">resolve</span>();
    }
  });
</span></code></pre><p>And in the end I can combine everything in one function and use it everywhere:</p><pre><code class="language-js hljs"><span class="hljs"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> loadAndInit = () =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">_load</span>().<span class="hljs-title function_">then</span>(_init);
};
</span></code></pre></div></div></div></body></html>