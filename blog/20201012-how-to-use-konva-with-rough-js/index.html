<!DOCTYPE html><html lang="en"><head><title>How to use Konva with Rough.js | Artem Demo</title><link rel="icon" type="image/x-icon" href="/./assets/favicon-dec32dcbac.ico"><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="Blog about web development, indie GameDev"><meta property="og:title" content="How to use Konva with Rough.js"><meta property="og:description" content="Blog about web development, indie GameDev"><link rel="stylesheet" href="/./assets/code-theme-36bdf5f7fe.css"><link rel="stylesheet" href="/./assets/site.render-5d1535d9c3.css"><script async src="https://www.googletagmanager.com/gtag/js?id=G-3BCNZ31TWL"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3BCNZ31TWL');</script></head><body><link rel="preload" as="image" href="regular-vs-rough-shape.png"><div><div class="header-wrapper"><div class="container"><div class="header-container"><div class="header-item header-item__logo"><a class="header-logo-link" href="/">Artem Demo &lt;/&gt;</a></div><div class="header-item header-item__menu"><div class="header-item-menu"><div class="top-menu"><div class="top-menu_item top-menu_item__active"><a class="top-menu_link" href="/">Blog</a></div><div class="top-menu_item"><a class="top-menu_link" href="/about/">About</a></div><div class="top-menu_item"><a class="top-menu_link" href="/contact/">Contact me</a></div></div></div></div></div><div class="header-separator"></div></div></div><div class="container"><div class="ContentWrapper"><h1>How to use Konva with Rough.js</h1><div class="secondary-text">12 October, 2020</div><div class="secondary-text">Tags:Â <a class="post-tags-item" href="/blog/tag/konva/">konva</a><a class="post-tags-item" href="/blog/tag/rough.js/">rough.js</a><a class="post-tags-item" href="/blog/tag/imgreview/">imgreview</a></div><p>For my <a href="https://artemdemo.github.io/imgreview/">ImgReview</a> app I wanted to use custom shapes with a hand-drawn, sketchy, appearance. They look nice and could add unique touch to your work:</p><p><img src="regular-vs-rough-shape.png" alt="Regular vs rough shape"></p><p>This hand-drawn, sketchy look can be generated with the help of a small library called rough.js. It doesn&#x27;t have additional dependencies and can be used as-is.</p><p>I&#x27;m already using Konva as my main graphic library, which makes my life easier by simplifying work with canvas.</p><p>So in order to start using rough.js I need somehow to make these two libraries work with each other. Both of them need to use the same reference to the canvas, but their approaches are different and may contradict (sort of).</p><p>Let&#x27;s see what we get from each one of them:</p><ul><li><a href="https://github.com/konvajs/konva">Konva</a> provides a framework and hides a boilerplate of canvas API. I obviously want that.</li><li><a href="https://github.com/rough-stuff/rough">Rough.js</a> helps me to create artistic patterns for my shapes, which is cool, and I want it as well.</li></ul><p>With a straight-forward approach I can&#x27;t pass a link to the canvas to rough.js and just draw whatever I want:</p><pre><code class="language-js hljs"><span class="hljs"><span class="hljs-keyword">const</span> roughCanvas = rough.<span class="hljs-title function_">canvas</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(&#x27;myCanvas&#x27;));
</span></code></pre><p>Produced shape will be disconnected from Konva life-cycles. I will need to add all the functionality by myself: click events, redrawing, dragging, transformation, etc. Obviously I would prefer no to do it.</p><p>Fortunately there is an additional api provided by Konva - <a href="https://konvajs.org/api/Konva.Shape.html">Shape</a> wrapper for custom shapes, which could be useful in case you want to implement your own logic. It provides a <a href="https://konvajs.org/api/Konva.Shape.html#sceneFunc__anchor">sceneFunc</a> method, so you can draw whatever you like.</p><p>Here is an example from the official documentation:</p><pre><code class="language-js hljs"><span class="hljs"><span class="hljs-keyword">const</span> customShape = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Konva</span>.<span class="hljs-title class_">Shape</span>({
  <span class="hljs-attr">x</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">y</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attr">fill</span>: &#x27;red&#x27;,
  <span class="hljs-comment">// a Konva.Canvas renderer is passed into the sceneFunc function</span>
  <span class="hljs-title function_">sceneFunc</span>(<span class="hljs-params">context, shape</span>) {
    context.<span class="hljs-title function_">beginPath</span>();
    context.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">200</span>, <span class="hljs-number">50</span>);
    context.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">420</span>, <span class="hljs-number">80</span>);
    context.<span class="hljs-title function_">quadraticCurveTo</span>(<span class="hljs-number">300</span>, <span class="hljs-number">100</span>, <span class="hljs-number">260</span>, <span class="hljs-number">170</span>);
    context.<span class="hljs-title function_">closePath</span>();
    <span class="hljs-comment">// Konva specific method</span>
    context.<span class="hljs-title function_">fillStrokeShape</span>(shape);
  },
});
</span></code></pre><p>You need to use context, provided by sceneFunc and not extract it yourself. Otherwise results will be unexpected.</p><p>The basic idea is as follows:</p><ol><li>I&#x27;m creating reference to the canvas with rough.js (<code class="hljs"><span class="hljs"><span class="hljs-variable language_">this</span>.#roughCanvas</span></code>). I need it in order to generate the path of the shape.</li><li>Then in the <code class="hljs"><span class="hljs">sceneFunc()</span></code> method I&#x27;m generating the path itself. I need it, so a path wouldn&#x27;t be created each time Konva decides to call <code class="hljs"><span class="hljs">sceneFunc()</span></code>.</li><li>Now rough.js doesn&#x27;t allow you to pass context to it. The library works only with reference to a canvas element. Therefore, I created a separate service - <code class="hljs"><span class="hljs">roughService</span></code>, that knows how to convert generated object to the shape.</li></ol><p>This is an excerpt from my code:</p><pre><code class="language-js hljs"><span class="hljs"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RectRough</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Rect</span> {
    type = <span class="hljs-title class_">EShapeTypes</span>.<span class="hljs-property">RECT_ROUGH</span>;

    readonly #roughCanvas;
    #lastDrawable;
    #<span class="hljs-attr">isDragging</span>: boolean = <span class="hljs-literal">false</span>;
    #<span class="hljs-attr">isScaling</span>: boolean = <span class="hljs-literal">false</span>;
    <span class="hljs-attr">shape</span>: <span class="hljs-title class_">Konva</span>.<span class="hljs-property">Shape</span>;

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props: TRectProps</span>) {
        <span class="hljs-variable language_">super</span>(props);
        <span class="hljs-variable language_">this</span>.#roughCanvas = rough.<span class="hljs-title function_">canvas</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">`.<span class="hljs-subst">${SHAPES_LAYER_CLS}</span>`</span>));
    }

    <span class="hljs-title function_">defineShape</span>(<span class="hljs-params"></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shape</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Konva</span>.<span class="hljs-title class_">Shape</span>({
            <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">x</span> || <span class="hljs-number">0</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">y</span> || <span class="hljs-number">0</span>,
            <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">width</span> || <span class="hljs-number">0</span>,
            <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">height</span> || <span class="hljs-number">0</span>,
            <span class="hljs-attr">stroke</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">stroke</span>,
            <span class="hljs-attr">strokeWidth</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">strokeWidth</span> / <span class="hljs-number">2</span>,
            <span class="hljs-attr">fill</span>: &#x27;transparent&#x27;,
            <span class="hljs-attr">draggable</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">sceneFunc</span>: (context, shape) =&gt; {
                <span class="hljs-keyword">const</span> selected = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isSelected</span>() &amp;&amp; !<span class="hljs-variable language_">this</span>.#isDragging;
                <span class="hljs-keyword">if</span> (selected || !<span class="hljs-variable language_">this</span>.#lastDrawable || <span class="hljs-variable language_">this</span>.#isScaling) {
                    <span class="hljs-variable language_">this</span>.#lastDrawable = <span class="hljs-variable language_">this</span>.#roughCanvas.<span class="hljs-property">generator</span>.<span class="hljs-title function_">rectangle</span>(
                        <span class="hljs-number">0</span>,
                        <span class="hljs-number">0</span>,
                        shape.<span class="hljs-title function_">getWidth</span>(),
                        shape.<span class="hljs-title function_">getHeight</span>(),
                        {
                            <span class="hljs-attr">roughness</span>: <span class="hljs-variable constant_">ROUGHNESS</span>,
                            <span class="hljs-attr">stroke</span>: shape.<span class="hljs-title function_">getStroke</span>(),
                        },
                    );
                    <span class="hljs-variable language_">this</span>.#isScaling = <span class="hljs-literal">false</span>;
                }
                roughService.<span class="hljs-title function_">draw</span>(context, <span class="hljs-variable language_">this</span>.#lastDrawable);
                context.<span class="hljs-title function_">fillStrokeShape</span>(shape);
            }
        });
    }
}
</span></code></pre><p>The full example can be found here <a href="https://github.com/artemdemo/imgreview/blob/369c1c10ad88ed2424d671b9bd5e752332484827/srcCanvas/RectLike/RectRough.ts">RectRough.ts</a> Also I didn&#x27;t create roughService by myself, just borrowed implementation from rough.js. The library <a href="https://github.com/rough-stuff/rough/blob/fd621f41c33996d9bc9334768ed5fd29243e49a1/src/canvas.ts">uses context under the hood</a>; it just doesn&#x27;t provide an API for that.</p></div></div></div></body></html>