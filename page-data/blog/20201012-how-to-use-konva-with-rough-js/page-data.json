{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/blog/20201012-how-to-use-konva-with-rough-js/","result":{"data":{"site":{"siteMetadata":{"title":"Artem Demo, indie developer","author":"Artem Demo"}},"markdownRemark":{"id":"aa332224-f50c-5f2c-8b55-db457b0aa55e","excerpt":"For my ImgReview app I wanted to use custom shapes with a hand-drawn, sketchy, appearance.\nThey look nice and could add unique touch to your…","html":"<p>For my <a href=\"https://imgreview.app/\">ImgReview</a> app I wanted to use custom shapes with a hand-drawn, sketchy, appearance.\nThey look nice and could add unique touch to your work:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 564px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/955db1c9bcd597ab18d7810bf36a3760/16918/regular-vs-rough-shape.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.21621621621622%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFElEQVQoz21SSQ7CQAzr/78BiAMHQGLfETudvVCeE+LMtBokDlYWxa6TTqGVIqW1QD+fMZYlSd+YWHMutbUyox+PiPs9crO5oknM9Up1t0ufTofeg4FEt99HYhJE7hcLqvt9eg2HVPd65FcrMiwME9AqlHPSDNMpue2W/HodwT232VA1GomQud2omkzInk7kDgeyx2PMmRO4j4gNWkE4RC720wql9+SXS3EAMuYU95oTCZgDLuaQR0F2ZC4XEWrXSzdrBOEQ68od8xnmQNDtdplDJtnz+a9gYBGIYW2cIBcUh1yLQzb147Aaj4UcZjMK83mMXOP48mcZL74nPi5zmEkAtxXMn8dfZE8i74vL5gnhD6ftvqjiFn+jyZdKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Regular vs rough shape\"\n        title=\"Regular vs rough shape\"\n        src=\"/static/955db1c9bcd597ab18d7810bf36a3760/16918/regular-vs-rough-shape.png\"\n        srcset=\"/static/955db1c9bcd597ab18d7810bf36a3760/3c361/regular-vs-rough-shape.png 148w,\n/static/955db1c9bcd597ab18d7810bf36a3760/03654/regular-vs-rough-shape.png 295w,\n/static/955db1c9bcd597ab18d7810bf36a3760/16918/regular-vs-rough-shape.png 564w\"\n        sizes=\"(max-width: 564px) 100vw, 564px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This hand-drawn, sketchy look can be generated with the help of a small library called rough.js.\nIt doesn’t have additional dependencies and can be used as-is.</p>\n<p>I’m already using Konva as my main graphic library, which makes my life easier by simplifying work with canvas.</p>\n<p>So in order to start using rough.js I need somehow to make these two libraries work with each other.\nBoth of them need to use the same reference to the canvas,\nbut their approaches are different and may contradict (sort of).</p>\n<p>Let’s see what we get from each one of them:</p>\n<ul>\n<li><a href=\"https://github.com/konvajs/konva\">Konva</a> provides a framework and hides a boilerplate of canvas API. I obviously want that.</li>\n<li><a href=\"https://github.com/rough-stuff/rough\">Rough.js</a> helps me to create artistic patterns for my shapes, which is cool, and I want it as well.</li>\n</ul>\n<p>With a straight-forward approach I can’t pass a link to the canvas to rough.js and just draw whatever I want:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> roughCanvas <span class=\"token operator\">=</span> rough<span class=\"token punctuation\">.</span><span class=\"token function\">canvas</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'myCanvas'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Produced shape will be disconnected from Konva life-cycles.\nI will need to add all the functionality by myself: click events, redrawing, dragging, transformation, etc.\nObviously I would prefer no to do it.</p>\n<p>Fortunately there is an additional api provided by Konva - <a href=\"https://konvajs.org/api/Konva.Shape.html\">Shape</a> wrapper for custom shapes,\nwhich could be useful in case you want to implement your own logic.\nIt provides a <a href=\"https://konvajs.org/api/Konva.Shape.html#sceneFunc__anchor\">sceneFunc</a> method, so you can draw whatever you like.</p>\n<p>Here is an example from the official documentation:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> customShape <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva<span class=\"token punctuation\">.</span>Shape</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  x<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n  y<span class=\"token operator\">:</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n  fill<span class=\"token operator\">:</span> <span class=\"token string\">'red'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// a Konva.Canvas renderer is passed into the sceneFunc function</span>\n  <span class=\"token function\">sceneFunc</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">context<span class=\"token punctuation\">,</span> shape</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    context<span class=\"token punctuation\">.</span><span class=\"token function\">beginPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span><span class=\"token function\">moveTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">50</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span><span class=\"token function\">lineTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">420</span><span class=\"token punctuation\">,</span> <span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span><span class=\"token function\">quadraticCurveTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">300</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">260</span><span class=\"token punctuation\">,</span> <span class=\"token number\">170</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span><span class=\"token function\">closePath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Konva specific method</span>\n    context<span class=\"token punctuation\">.</span><span class=\"token function\">fillStrokeShape</span><span class=\"token punctuation\">(</span>shape<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>You need to use context, provided by sceneFunc and not extract it yourself. Otherwise results will be unexpected.</p>\n<p>The basic idea is as follows:</p>\n<ol>\n<li>I’m creating reference to the canvas with rough.js (<code class=\"language-text\">this.#roughCanvas</code>). I need it in order to generate the path of the shape.</li>\n<li>Then in the <code class=\"language-text\">sceneFunc()</code> method I’m generating the path itself. I need it, so a path wouldn’t be created each time Konva decides to call <code class=\"language-text\">sceneFunc()</code>.</li>\n<li>Now rough.js doesn’t allow you to pass context to it. The library works only with reference to a canvas element. Therefore, I created a separate service - <code class=\"language-text\">roughService</code>, that knows how to convert generated object to the shape.</li>\n</ol>\n<p>This is an excerpt from my code:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">RectRough</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Rect</span> <span class=\"token punctuation\">{</span>\n    type <span class=\"token operator\">=</span> EShapeTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">RECT_ROUGH</span><span class=\"token punctuation\">;</span>\n\n    readonly #roughCanvas<span class=\"token punctuation\">;</span>\n    #lastDrawable<span class=\"token punctuation\">;</span>\n    #isDragging<span class=\"token operator\">:</span> boolean <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    #isScaling<span class=\"token operator\">:</span> boolean <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    shape<span class=\"token operator\">:</span> Konva<span class=\"token punctuation\">.</span>Shape<span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props<span class=\"token operator\">:</span> TRectProps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#roughCanvas <span class=\"token operator\">=</span> rough<span class=\"token punctuation\">.</span><span class=\"token function\">canvas</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">.</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">SHAPES_LAYER_CLS</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">defineShape</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>shape <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Konva<span class=\"token punctuation\">.</span>Shape</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            x<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>x <span class=\"token operator\">||</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n            y<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>y <span class=\"token operator\">||</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n            width<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>width <span class=\"token operator\">||</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n            height<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>height <span class=\"token operator\">||</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n            stroke<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>stroke<span class=\"token punctuation\">,</span>\n            strokeWidth<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>strokeWidth <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n            fill<span class=\"token operator\">:</span> <span class=\"token string\">'transparent'</span><span class=\"token punctuation\">,</span>\n            draggable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n            <span class=\"token function-variable function\">sceneFunc</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">context<span class=\"token punctuation\">,</span> shape</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">const</span> selected <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">isSelected</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#isDragging<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>selected <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#lastDrawable <span class=\"token operator\">||</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#isScaling<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#lastDrawable <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#roughCanvas<span class=\"token punctuation\">.</span>generator<span class=\"token punctuation\">.</span><span class=\"token function\">rectangle</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                        shape<span class=\"token punctuation\">.</span><span class=\"token function\">getWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        shape<span class=\"token punctuation\">.</span><span class=\"token function\">getHeight</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token punctuation\">{</span>\n                            roughness<span class=\"token operator\">:</span> <span class=\"token constant\">ROUGHNESS</span><span class=\"token punctuation\">,</span>\n                            stroke<span class=\"token operator\">:</span> shape<span class=\"token punctuation\">.</span><span class=\"token function\">getStroke</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#isScaling <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                roughService<span class=\"token punctuation\">.</span><span class=\"token function\">draw</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>#lastDrawable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                context<span class=\"token punctuation\">.</span><span class=\"token function\">fillStrokeShape</span><span class=\"token punctuation\">(</span>shape<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The full example can be found here <a href=\"https://github.com/artemdemo/imgreview/blob/369c1c10ad88ed2424d671b9bd5e752332484827/srcCanvas/RectLike/RectRough.ts\">RectRough.ts</a>\nAlso I didn’t create roughService by myself, just borrowed implementation from rough.js.\nThe library <a href=\"https://github.com/rough-stuff/rough/blob/fd621f41c33996d9bc9334768ed5fd29243e49a1/src/canvas.ts\">uses context under the hood</a>;\nit just doesn’t provide an API for that.</p>","frontmatter":{"title":"How to use Konva with Rough.js","date":"October 12, 2020","tags":["konva","rough.js","imgreview"]}}},"pageContext":{"slug":"/20201012-how-to-use-konva-with-rough-js/","previous":{"fields":{"slug":"/20201009-imgreview-announce/"},"frontmatter":{"title":"ImgReview announce","tags":["imgreview"]}},"next":{"fields":{"slug":"/20201017-adding-react-snap-to-my-app/"},"frontmatter":{"title":"Adding react-snap to my app","tags":["react-snap","prerender","imgreview"]}}}},"staticQueryHashes":[]}